% Use only LaTeX2e, calling the article.cls class and 12-point type.

\documentclass[11pt]{article}

\usepackage[round,semicolon]{natbib}
\usepackage{etoolbox}
\AtBeginEnvironment{quote}{\singlespacing\tiny}
% Use times if you have the font installed; otherwise, comment out the
% following line.

% \usepackage{times} AFM: I can't tell bold from not bold in things like x and y in Times font, disabling for now
\usepackage{amssymb}
\usepackage{amsmath}

% for adjustwidth
\usepackage{changepage}

% The following parameters seem to provide a reasonable page setup.

\topmargin 0.0cm
\oddsidemargin 1cm
\textwidth 15cm
\textheight 21cm
\footskip 1.0cm

\usepackage{newfloat}
\usepackage{amsmath}
\usepackage[labelfont=bf]{caption}
\usepackage{nameref}
\usepackage{rotating}
\usepackage{color}
\usepackage{float}

\usepackage[dvipsnames]{xcolor}

\newcommand\skhcomment[1]{{\color{violet}[\textbf{SH comment:} #1]}}
\newcommand\wdcomment[1]{{\color{teal}[\textbf{WD comment:} #1]}}
\newcommand\amcomment[1]{{\color{orange}[\textbf{AM comment:} #1]}}


\usepackage{hyperref}
\hypersetup{colorlinks,citecolor=blue,linkcolor=blue,urlcolor=blue}
\hypersetup{colorlinks,citecolor=blue,linkcolor=blue,urlcolor=blue}

\title{Models}

\author{Will DeWitt, Sarah Hilton, Andy Magee}

% Include the date command, but leave its argument blank.
\date{}
\usepackage{setspace}
\onehalfspacing

%%% Beginning of the Document
\begin{document}
\maketitle

\section*{Goal and Housekeeping}

Andy re-implemented the model from \cite{nasrallah2013phylogenetic}, which models pair-wise epistasis due to RNA secondary structure.
Below is the model as Andy implemented it in \texttt{RevBayes}.
\skhcomment{Comments from Sarah look like this.}
\wdcomment{Comments from Will look like this.}
\amcomment{Comments from Andy look like this.}

\section*{RNA epistasis model}

Here is the model from \cite{nasrallah2013phylogenetic}.
\skhcomment{I am just copying over what is found in the paper. We should change this around in an order we like and with notation we like.}

$\boldsymbol{Q}$ is the instantaneous rate matrix describing changes from doublet $\boldsymbol{x}$ to doublet $\boldsymbol{y}$.
For $\boldsymbol{x} = (x_1, x_2)$, $x_1$ is the 5' nucleotide and $x_2$ is the 3' nucleotide.
\begin{equation}
\label{eq:Q}
\boldsymbol{Q} = \xi \times
\begin{cases}
   \pi_{\boldsymbol{y}} S_{x_1, y_1} & \mbox{if single substitution at the 5' site,} \\
   \pi_{\boldsymbol{y}} S_{x_2, y_2} & \mbox{if single substitution at the 3' site,} \\
   \pi_{\boldsymbol{y}} S_{x_1, y_1} S_{x_2, y_2} d & \mbox{if double substitution where ${\boldsymbol{x}}$ and ${\boldsymbol{y}}$ $\in {\boldsymbol{W}}$,} \\
   0 & \mbox{if any other double substitution,} \\
   - \sum_{\boldsymbol{x} \ne \boldsymbol{y}} Q_{\boldsymbol{x},\boldsymbol{y}}& \mbox{if $\boldsymbol{x}$ = $\boldsymbol{y}$} \\
   \end{cases}
\end{equation}
$\boldsymbol{S}$ is the GTR exchangeability matrix \citep{tavare1986some} and $S_{x_i,y_i}$ is understood to be the element in $S$ governing the rate of exchangeability between nucleotide $x_i$ and $y_i$ (by definition, $S_{x_i,y_i} = S_{y_i,x_i}$),
${\boldsymbol{W}} = {AT, CG, GC, TA}$ is the set of Watson-Crick pairs,
$\boldsymbol{\pi} = (\pi_{AA}, \pi_{AC}, ..., \pi_{TT})$ are the stationary state frequencies of the 16 possible doublet states,
$d$ controls rate of double to single mutations between doublets,
and $\xi$ is the rate-scaling factor.

\subsection*{Points to clarify}

\subsubsection*{How do we interpret $d$?}

$d$ is the relative rate of double to single mutations between doublets or the "strength" of epistatic interactions.

\amcomment{Nasrallah says relative proportion, we've been saying relative rate. Are these the same?}

Here is a copy of table 1 from \cite{nasrallah2013phylogenetic}:

\begin{tabular}{ |p{1cm}|p{5cm}|p{5cm}|  }
 \hline
& $\pi_{\boldsymbol{y}} = \pi_{y_1}\pi_{y_2}$&$\pi_{\boldsymbol{y}} \ne \pi_{y_1}\pi_{y_2}$\\
 \hline
$d=0$  & Independent and nonepistatic & Model inadequacy \\
\hline
 $d > 0$  & Dependent but nonepistatic & Dependent and epistatic\\
 \hline
\end{tabular}

\skhcomment{We talked about this last time but I want to make sure I totally understand. When we are simulating with $d=0$, we are actually in the ``model inadequacy" quadrant?}
\amcomment{Yes!}

\subsubsection*{How do we normalize $\boldsymbol{Q}$ ($\xi$)?}

\skhcomment{From slack: 0.5 * Pr(single) + Pr(double) }

\amcomment{It is not completely clear how $\xi$ is defined in the paper.
Na{\"i}vely, I first assumed it was defined in the usual way (which RevBayes can do for us), simply taking a weighted sum of the off-diagonal elements $\xi^{-1} = \sum_{\boldsymbol{x}} \sum_{\boldsymbol{y} \ne \boldsymbol{x}} \pi_{\boldsymbol{x}} Q_{\boldsymbol{x},\boldsymbol{y}}$.
However, this normalizes the rate matrix on paired sites, which would count both doublet substitutions and single-substitutions equally.
This formulation does not guarantee that the number of expected substitutions per unpaired epistatic site is the same as per non-epistatic site.
Thus it seems that the appropriate normalization should be defined by,
\begin{align*}
\xi^{-1} = \sum_{\boldsymbol{x}} \sum_{\boldsymbol{y} \ne \boldsymbol{x}} \pi_{\boldsymbol{x}} \times
\begin{cases}
   \frac{1}{2}Q_{\boldsymbol{x},\boldsymbol{y}} & \mbox{if single substitution,} \\
   Q_{\boldsymbol{x},\boldsymbol{y}} & \mbox{if double substitution of the allowed type,} \\
   \end{cases}
\end{align*}
This \textit{should} recognize the fact that single substitutions change only one site in the pair.
We have to do this normalization ourselves, and can't just make RevBayes do it for us, but that's more me whining than anything important.}


\subsubsection*{Given the fit parameter values for a GTR model, how do we simulate under this model?}

\skhcomment{From github, ``
This is the tree inferred under GTR+GAMMA using RAxML version 8.2.12. Inferred model parameters

alpha shape parameter = 0.440894

relative exchange rates (ac ag at cg ct gt) = 1.882161 7.009179 0.914813 0.495852 7.666181 1.000000

base frequencies = 0.340152 0.190828 0.225045 0.243974"}

\amcomment{
Under the parameterization in the paper (standard MrBayes/RevBayes parameterization), we first take the RER and simplex them, yielding $\boldsymbol{r} = (0.0992,0.3695,0.0482,0.0261,0.4042,0.0527)$.
Then we make the symmetric GTR rate matrix $\boldsymbol{S}$ from the relative rates (for entirely too much detail, we put the elements of $\boldsymbol{r}$ into the upper diagonal of $\boldsymbol{S}$ row-wise, and the lower-diagonal column-wise, to make the symmetric exchangeability matrix).
Then we draw the doublet stationary frequencies $\boldsymbol{\pi}$ from a Dirichlet(2,...,2) distribution.
Then we assemble an unscaled version of 16 x 16 matrix $\boldsymbol{Q}$ as described \ref{eq:Q}, while calculating $\xi$.
Then we normalize $\boldsymbol{Q}$, tell RevBayes that's our rate matrix on the flu tree, and draw from the induced phylogenetic CTMC distribution.
Rev simulates these as characters 0,1,2,...,D,E,F.
We also simulate the non-epistatic sites, and with an R script we turn the 16-state characters into pairs of sites, and add them to the nonepistatic sites.
}

\clearpage
\bibliographystyle{mbe}
{\small
\bibliography{references.bib}
}


\end{document}
